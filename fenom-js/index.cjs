"use strict";function e(e,t){const s={type:"if",condition:e[t].condition,body:[],elseIfs:[],elseBody:[]};let o=t+1,n=0;const c=[],i=[],a=[];let l=null,p=!1;for(;o<e.length;){const t=e[o];if("if"===t.type&&n++,"endif"===t.type){if(0===n)break;n--}if(n>0)l||p?l?l.tokens.push(t):p&&a.push(t):c.push(t),o++;else if("elseif"!==t.type)if("else"!==t.type){if("endif"===t.type)break;l||p?l?l.tokens.push(t):p&&a.push(t):c.push(t),o++}else p=!0,o++;else l||p?l?l.tokens.push(t):p&&a.push(t):(l={condition:t.condition,tokens:[]},i.push(l)),o++}return s.body=r(c),s.elseIfs=i.map(e=>({condition:e.condition,body:r(e.tokens)})),s.elseBody=r(a),{node:s,nextIndex:o+1}}function t(e,t){const s=e[t],r={type:"for",key:s.key||null,item:s.item,collection:s.collection,reverse:Boolean(s.reverse),body:[],elseBody:[]};let o=t+1,n=0,c=!1;for(;o<e.length;){const t=e[o];if("for"===t.type&&n++,"endfor"===t.type){if(n>0){n--,c?r.elseBody.push(t):r.body.push(t),o++;continue}return{node:r,nextIndex:o+1}}if(n>0)c?r.elseBody.push(t):r.body.push(t),o++;else if("foreachelse"!==t.type)["break","continue"].includes(t.type),c?r.elseBody.push(t):r.body.push(t),o++;else{if(0===n){c=!0,o++;continue}r.body.push(t),o++}}throw new Error("Unclosed for loop: expected {/for}")}function s(e,t){const s={type:"switch",value:e[t].value,cases:[],defaultBody:[]};let r=t+1,o=0,n=null,c=!1;for(;r<e.length;){const t=e[r];if("switch"===t.type&&o++,"endswitch"===t.type){if(o>0){o--,n&&n.body.push(t),r++;continue}return{node:s,nextIndex:r+1}}if(o>0)n&&n.body.push(t),r++;else if("case"!==t.type)if("default"!==t.type)n?n.body.push(t):c?s.defaultBody.push(t):s.cases.length>0&&s.cases[s.cases.length-1].body.push(t),r++;else{if(c)throw new Error("Duplicate {default} in switch");c=!0,n=null,r++}else n={value:t.value,body:[]},s.cases.push(n),r++}throw new Error("Unclosed switch: expected {/switch}")}function r(o){const n=[];let c=0;for(;c<o.length;){const i=o[c];if("block_open"===i.type){const e=i.name;c++;const t=[];let s=0;for(;c<o.length;){const e=o[c];if("block_open"===e.type&&s++,"block_close"===e.type){if(0===s)break;s--}t.push(e),c++}const a=r(t);n.push({type:"block",name:e,body:a}),c++;continue}if("extends"!==i.type)if("include"!==i.type)if(["set","var","add"].includes(i.type))n.push({...i}),c++;else{if("if"===i.type){const{node:t,nextIndex:s}=e(o,c);n.push(t),c=s;continue}if("for"===i.type||"foreach"===i.type){const{node:e,nextIndex:s}=t(o,c);n.push(e),c=s;continue}if("switch"===i.type){const{node:e,nextIndex:t}=s(o,c);n.push(e),c=t;continue}if("output"===i.type){const e=i.value.match(/^\{\$(.+)\}$/);if(!e){n.push({type:"text",value:i.value}),c++;continue}const t=e[1].trim().split("|"),s=t[0],r=t.slice(1);n.push({type:"output",name:`$${s}`,filters:r}),c++;continue}n.push({...i}),c++}else n.push({...i}),c++;else n.push({...i}),c++}return n}Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const o=e=>"true"===(e=e.trim())?"true":"false"===e?"false":"null"===e?"null":"undefined"===e?"undefined":isNaN(Number(e))||e.includes(" ")?e.startsWith("[")&&e.endsWith("]")||e.startsWith("{")&&e.endsWith("}")||e.includes("$")?e.replace(/\$(\w+)/g,"context.$1"):JSON.stringify(e):e;function n(e){const t=e.trim();if(t.includes("~"))return function(e){const t=[];let s="",r=!1,o=0;for(let n of e)'"'!==n&&"'"!==n||0!==o||(r=!r),"("!==n||r||o++,")"!==n||r||o--,"~"!==n||r||0!==o?s+=n:s.trim()&&(t.push(s.trim()),s="");s.trim()&&t.push(s.trim());return 0===t.length?'""':1===t.length?n(t[0]):t.map(e=>n(e)).join(" + ")}(t);if(/^['"].*['"]$/.test(t))return t;if(/^\d+$/.test(t))return t;if("true"===t||"false"===t||"null"===t)return t;if(t.startsWith("$")){const e=t.slice(1).split(".");return e.length>1?`(${e.map((t,s)=>"context."+e.slice(0,s+1).join(".")).join(" != null ? ")+" != null ? context."+e.join(".")+":null".repeat(e.length)})`:`context.${e[0]}`}return`(${t})`}function c(e,t,s){return(r,...o)=>{const n=typeof r,c=Array.isArray(r),i="string"===n,a=r&&"object"==typeof r&&!c;let l=!1;if("array"===t&&(l=c),"string"===t&&(l=i),"object"===t&&(l=a),"number"===t&&(l=!isNaN(Number(r))),!l&&null!=r){const s=c?"array":i?"string":a?"object":n;console.warn(`[Fenom] filter '${e}' expects ${t}, got ${s}`)}return s(r,...o)}}function i(e){return e.replace(/\$(\w+(?:\.\w+)*)(?:\|(\w+)(?::([^:\s}]+))?(?::([^:\s}]+))?)*/g,(e,t,s,r,o)=>{t.replace(/\./g,"][");const c=n(`$${t}`);if(!s)return c;const i=[];r&&i.push(/^['"]/.test(r)?r:n("$"+r)),o&&i.push(/^['"]/.test(o)?o:n("$"+o));const a=i.join(", ");return`filters["${s}"](${c}${a?", "+a:""})`})}const a=[...[{type:"extends",regex:/^\{extends\s+['"]file:([^'"]+)['"]\s*\}/,process:e=>({file:e[1]})},{type:"block_open",regex:/^\{block\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2]})},{type:"block_close",regex:/^\{\/block\}/},{type:"parent",regex:/^\{parent\}/},{type:"paste",regex:/^\{paste\s+(['"])(.*?)\1\}/,process:e=>({name:e[2]})},{type:"use",regex:/^\{use\s+(['"])(.*?)\1\}/,process:e=>({file:e[2]})}],{type:"include",regex:/^\{include\s+['"]file:([^'"]+)['"](?:\s+((?:\s*\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s}]+))+))?\s*\}/,process:e=>{const t=e[1],s=e[2],r={};if(s){const e=/(\w+)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s}]+))/g;let t;for(;null!==(t=e.exec(s));){const e=t[1],s=t[2]||t[3]||t[4]||"";r[e]=s}}return{file:t,params:r}}},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,item:e[3],key:null,reverse:e[0].includes("| reverse")})},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)\s*=>\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,key:e[3],item:e[4],reverse:e[0].includes("| reverse")})},{type:"endfor",regex:/^\{\/(?:for|foreach)\}/},{type:"break",regex:/^\{break\}/i},{type:"continue",regex:/^\{continue\}/i},...[{type:"switch",regex:/^\{switch\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"case",regex:/^\{case\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"default",regex:/^\{default\}/},{type:"endswitch",regex:/^\{\/switch\}/}],{type:"operator",regex:/^\{\$(\w+)\s*(\+\+|--|\+=|-=|\*=|\/=|\%=)\s*([^}]+)?\}/,process:e=>({variable:e[1],operator:e[2],value:e[3]?.trim()||"1"})},...[{type:"if",regex:/^\{if\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"elseif",regex:/^\{elseif\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"else",regex:/^\{else\}/},{type:"endif",regex:/^\{\/if\}/}],{type:"ignore_block",regex:/^\{ignore\}([\s\S]*?)\{\/ignore\}/,process:e=>({content:e[1]})},...[{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(\{[^}]*\}|\[[^}]*\])\}/,process:e=>({variable:e[1],value:e[2]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*([^}\s][^}]*)\}/,process:e=>({variable:e[1],value:e[2].trim()})},{type:"add",regex:/^\{add\s+\$(\w+)\s*\+\+\}/,process:e=>({variable:e[1]})},{type:"var",regex:/^\{var\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})}],...[{type:"unset",regex:/^\{unset\s+\$(\w+)\}/,process:e=>({variable:e[1]})},{type:"comment",regex:/^\{\*\s*([\s\S]*?)\s*\*\}/}],{type:"output",regex:/^\{output\s+name\s*=\s*(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+([^\s}]+)\s*\}/,process:e=>({name:e[1],filters:[]})},{type:"output",regex:/^\{output\s+(\$?[^}]+)\}/,process:e=>({name:e[1].trim(),filters:[]})},{type:"output",regex:/^\{\$(.+?)\}/,process:e=>{const t=e[1].trim().split("|").map(e=>e.trim());return{name:`$${t[0]}`,filters:t.slice(1)}}},{type:"output",regex:/^\{([^$].+?)\}/,process:e=>({name:e[1].trim(),filters:[]})},...[{type:"cycle",regex:/^\{cycle\s+(.+?)\}/,process:e=>({values:e[1]})}],...[{type:"filter",regex:/^\{filter\s+(.+?)\}/,process:e=>({filter:e[1].trim()})},{type:"endfilter",regex:/^\{\/filter\}/},{type:"raw",regex:/^\{raw\}/},{type:"endraw",regex:/^\{\/raw\}/},{type:"autoescape",regex:/^\{autoescape\}/},{type:"endautoescape",regex:/^\{\/autoescape\}/}],...[{type:"macro",regex:/^\{macro\s+(\w+)(?:\s*\((.*?)\))?\}/,process(e){const t=e[2]?e[2].split(",").map(e=>e.trim()):[];return{name:e[1],args:t}}},{type:"endmacro",regex:/^\{\/macro\}/},{type:"import",regex:/^\{import\s+(['"])(.*?)\1\s+as\s+(\w+)\}/,process:e=>({file:e[2],alias:e[3]})}]];function l(e){const t=[];let s=0;for(;s<e.length;){let r=!1;if(e.slice(s).startsWith("{ignore}")){let o=1,n=s+8;for(;n<e.length;)if(e.slice(n).startsWith("{ignore}"))o++,n+=8;else if(e.slice(n).startsWith("{/ignore}")){if(o--,n+=9,0===o){const o=e.slice(s+8,n-9);t.push({type:"text",value:o}),s=n,r=!0;break}}else n++;r||(t.push({type:"text",value:"{ignore}"}),s+=8);continue}if("{"!==e[s]){const r=e.indexOf("{",s);if(-1===r){t.push({type:"text",value:e.slice(s)});break}r>s&&t.push({type:"text",value:e.slice(s,r)}),s=r}for(const o of a){const n=e.slice(s).match(o.regex);if(n){const e={type:o.type,value:n[0]};if("comment"===o.type){s+=n[0].length,r=!0;break}o.process&&Object.assign(e,o.process(n)),t.push(e),s+=n[0].length,r=!0;break}}if(!r){const t=e.slice(s,s+30).replace(/\n/g,"↵");console.warn(`Skip unknown tag at ${s}: "${t}"`),s++}}return t}const p={upper:e=>String(e).toUpperCase(),lower:e=>String(e).toLowerCase(),capitalize:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},ucfirst:e=>p.capitalize(e),ucwords:e=>String(e).trim().replace(/\b\w/g,e=>e.toUpperCase()),lcfirst:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toLowerCase()+t.slice(1)},trim:e=>String(e).trim(),ltrim:e=>String(e).replace(/^\s+/,""),rtrim:e=>String(e).replace(/\s+$/,""),nl2br:e=>String(e).replace(/\n/g,"<br>"),replace:(e,t,s)=>String(e).split(String(t)).join(String(s)),substr:c("substr","string",(e,t,s)=>{const r=String(e);return void 0===s?r.slice(t):r.slice(t,t+s)}),urlencode:e=>encodeURIComponent(String(e)),urldecode:e=>decodeURIComponent(String(e)),escape:c("escape","string",e=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),e:e=>p.escape(e),first:c("first","array",e=>Array.isArray(e)?e[0]:e&&"object"==typeof e?Object.values(e)[0]:""),last:c("last","array",e=>{if(Array.isArray(e))return e[e.length-1];if(e&&"object"==typeof e){const t=Object.values(e);return t[t.length-1]}return""}),join:c("join","array",(e,t=",")=>Array.isArray(e)?e.join(t):e&&"object"==typeof e?Object.values(e).join(t):String(e)),reverse:c("reverse","array",e=>Array.isArray(e)?[...e].reverse():"string"==typeof e?e.split("").reverse().join(""):e),sort:c("sort","array",e=>Array.isArray(e)?[...e].sort():e),ksort:c("ksort","object",e=>{if(e&&"object"==typeof e){const t={};return Object.keys(e).sort().forEach(s=>{t[s]=e[s]}),t}return e}),unique:c("unique","array",e=>Array.isArray(e)?[...new Set(e)]:e),shuffle:c("shuffle","array",e=>{if(!Array.isArray(e))return e;const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}),slice:(e,t,s)=>Array.isArray(e)||"string"==typeof e?void 0===s?e.slice(t):e.slice(t,t+s):e,merge:(e,t)=>Array.isArray(e)&&Array.isArray(t)?[...e,...t]:e,batch:(e,t)=>{if(!Array.isArray(e))return e;const s=[];for(let r=0;r<e.length;r+=t)s.push(e.slice(r,r+t));return s},keys:e=>e&&"object"==typeof e?Object.keys(e):[],values:e=>e&&"object"==typeof e?Object.values(e):[],length:e=>Array.isArray(e)?e.length:e&&"object"==typeof e?Object.keys(e).length:String(e).length,number_format:(e,t=0,s=".",r=",")=>{const o=Number(e);return isNaN(o)?"":o.toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:!0}).replace(/,/g,r).replace(/\./g,s)},abs:e=>Math.abs(Number(e)||0),round:(e,t=0)=>{const s=10**t;return Math.round((Number(e)||0)*s)/s},json_encode:e=>JSON.stringify(e),json_decode:e=>{try{return JSON.parse(String(e))}catch{return null}},date:(e,t="d.m.Y")=>{const s=Number(e),r=new Date(isNaN(s)?e:1e3*s);if(isNaN(r.getTime()))return console.warn(`[Fenom] filter 'date' received invalid timestamp: ${e}`),"";const o=e=>e.toString().padStart(2,"0");return t.replace(/d/g,o(r.getDate())).replace(/m/g,o(r.getMonth()+1)).replace(/Y/g,r.getFullYear().toString()).replace(/H/g,o(r.getHours())).replace(/i/g,o(r.getMinutes())).replace(/s/g,o(r.getSeconds()))},default:(e,t)=>null==e||""===e||"object"==typeof e&&0===Object.keys(e).length?t:e,raw:e=>e,var_dump:e=>`<pre>${JSON.stringify(e,null,2)}</pre>`,print_r:e=>`<pre>${e instanceof Object?JSON.stringify(e,null,2):String(e)}</pre>`};exports.FenomJs=function(e,t,s){const{root:c,loader:a,minify:u}=s||{root:"./src/"},f=a||(()=>"");try{const s=l(e),c=function(e,t){const s={};let c=null;const a=[];for(const r of e)"extends"!==r.type?"block"===r.type&&(s[r.name]=r.body):c=r.file;const p=e.filter(e=>"extends"!==e.type&&"block_open"!==e.type&&"block_close"!==e.type);function u(e){var c;if(!["extends","block_open","block_close"].includes(e.type)&&!["endfor"].includes(e.type))switch(e.type){case"operator":{const{variable:t,operator:s,value:r}=e,o=e=>e.startsWith("$")?`context.${e.slice(1)}`:isNaN(+e)?`'${e}'`:+e;switch(s){case"++":a.push(`context.${t} = (context.${t} || 0) + 1;`),a.push(`out += context.${t} - 1;`);break;case"--":a.push(`context.${t} = (context.${t} || 0) - 1;`),a.push(`out += context.${t} + 1;`);break;case"+=":a.push(`context.${t} = (context.${t} || 0) + ${o(r)};`),a.push(`out += context.${t};`);break;case"-=":a.push(`context.${t} = (context.${t} || 0) - ${o(r)};`),a.push(`out += context.${t};`);break;case"*=":a.push(`context.${t} = (context.${t} || 0) * ${o(r)};`),a.push(`out += context.${t};`);break;case"/=":a.push(`context.${t} = (context.${t} || 0) / ${o(r)};`),a.push(`out += context.${t};`);break;case"%=":a.push(`context.${t} = (context.${t} || 0) % ${o(r)};`),a.push(`out += context.${t};`)}break}case"ignore_block":a.push(`out += ${JSON.stringify(e.content)};`);break;case"include":try{const s=r(l(t(e.file)));if(e.params)for(const[t,r]of Object.entries(e.params))if("string"==typeof r)if(r.startsWith("$")){const e=r.slice(1);a.push(`context.${t} = context.${e};`)}else a.push(`context.${t} = ${JSON.stringify(r)};`);else a.push(`context.${t} = ${JSON.stringify(r)};`);s.forEach(u)}catch(p){a.push(`out += '[Include error: ${e.file}]';`)}break;case"text":a.push(`out += ${JSON.stringify(e.value)};`);break;case"output":{const t=n(e.name);let s=t;for(const r of e.filters){const e=r.split(":").map(e=>e.trim()),t=e[0],o=e.slice(1).map(e=>/^['"].*['"]$/.test(e)?e:n(e.startsWith("$")?e:"$"+e));s=`filters["${t}"](${s}${o.length>0?", "+o.join(", "):""})`}if(0===e.filters.length){const e=`(typeof ${t} === 'object' || ${t} === null ? '' : ${t})`;a.push(`out += ${e};`)}else a.push(`out += ${s};`);break}case"set":a.push(`context.${e.variable} = ${o(e.value)};`);break;case"var":a.push(`if (context.${e.variable} === undefined) context.${e.variable} = ${o(e.value)};`);break;case"add":a.push(`context.${e.variable} = (context.${e.variable} || 0) + 1;`);break;case"if":{const t=i(e.condition);a.push(`if (${t}) {`),e.body.forEach(u),a.push("}"),e.elseIfs.forEach(e=>{const t=i(e.condition);a.push(`else if (${t}) {`),e.body.forEach(u),a.push("}")}),e.elseBody.length>0&&(a.push("else {"),e.elseBody.forEach(u),a.push("}"));break}case"for":{const t=n(e.collection),s=`context.${e.item}`,r=e.key?`context.${e.key}`:null,o=`i_${e.item}`;a.push(`if (${t} && Array.isArray(${t}) && ${t}.length > 0) {`),e.reverse?a.push(`for (let ${o} = ${t}.length - 1; ${o} >= 0; ${o}--) {`):a.push(`for (let ${o} = 0; ${o} < ${t}.length; ${o}++) {`),r&&a.push(`${r} = ${o};`),a.push(`${s} = ${t}[${o}];`),e.body.forEach(u),a.push("}"),a.push("}"),e.elseBody&&e.elseBody.length>0&&(a.push("else {"),e.elseBody.forEach(u),a.push("}"));break}case"switch":a.push(`switch (${c=e.value,(c=c.replace(/(\$[a-zA-Z_]\w*(?:\.\w+)*)\s*[\?:!]\s*:/g,"$1 ? $1 : ")).replace(/\$([a-zA-Z_]\w*(?:\.\w+)*)/g,"context.$1")}) {`),e.cases.forEach(e=>{a.push(`case ${e.value}: {`),e.body.forEach(u),a.push("break; }")}),e.defaultBody&&e.defaultBody.length>0&&(a.push("default: {"),e.defaultBody.forEach(u),a.push("break; }")),a.push("}");break;case"block":{const t=s[e.name]||e.body;Array.isArray(t)?t.forEach(u):console.warn(`Block "${e.name}" has no body and no override`);break}default:console.warn(`Unknown node type: ${e.type}`)}}c&&e.some((e,t)=>"extends"===e.type&&0!==t)&&console.warn("{extends} должен быть первым тегом в шаблоне"),c?r(l(t(c))).forEach(u):p.forEach(u);const f=`\n        let out = '';\n        ${a.join("\n")}\n        return out;\n    `;return new Function("context","filters",f)}(r(s),f),a=c(t,p);return u?function(e){return e.replace(/>\s+</g,"><").replace(/\s{2,}/g," ").replace(/(<!--.*?-->)\s+/g,"$1").trim()}(a):a}catch(y){return console.error("Template error:",y),`<span style='color:red'>[Ошибка шаблона: ${y.message}]</span>`}};
