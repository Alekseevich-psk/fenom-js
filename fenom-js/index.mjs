const e=[...[{type:"extends",regex:/^\{extends\s+['"]file:([^'"]+)['"]\s*\}/,process:e=>({file:e[1]})},{type:"block_open",regex:/^\{block\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2]})},{type:"block_close",regex:/^\{\/block\}/},{type:"parent",regex:/^\{parent\}/},{type:"paste",regex:/^\{paste\s+(['"])(.*?)\1\}/,process:e=>({name:e[2]})},{type:"use",regex:/^\{use\s+(['"])(.*?)\1\}/,process:e=>({file:e[2]})}],{type:"include",regex:/^\{include\s+['"]file:([^'"]+)['"](?:\s+((?:\s*\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s}]+))+))?\s*\}/,process:e=>{const t=e[1],r=e[2],s={};if(r){const e=/(\w+)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s}]+))/g;let t;for(;null!==(t=e.exec(r));){const e=t[1],r=t[2]||t[3]||t[4]||"";s[e]=r}}return{file:t,params:s}}},...[{type:"for_range",regex:/^\{(for|foreach)\s+(\d+)\.\.(\d+)\s+as\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({start:parseInt(e[2],10),end:parseInt(e[3],10),item:e[4],reverse:e[0].includes("| reverse")})},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,item:e[3],key:null,reverse:e[0].includes("| reverse")})},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)\s*=>\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,key:e[3],item:e[4],reverse:e[0].includes("| reverse")})},{type:"endfor",regex:/^\{\/(?:for|foreach)\}/},{type:"break",regex:/^\{break\}/i},{type:"continue",regex:/^\{continue\}/i}],...[{type:"switch",regex:/^\{switch\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"case",regex:/^\{case\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"default",regex:/^\{default\}/},{type:"endswitch",regex:/^\{\/switch\}/}],{type:"operator",regex:/^\{\$(\w+)\s*(\+\+|--|\+=|-=|\*=|\/=|\%=)\s*([^}]+)?\}/,process:e=>{var t;return{variable:e[1],operator:e[2],value:(null==(t=e[3])?void 0:t.trim())||"1"}}},...[{type:"if",regex:/^\{if\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"elseif",regex:/^\{elseif\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"else",regex:/^\{else\}/},{type:"endif",regex:/^\{\/if\}/}],{type:"ignore_block",regex:/^\{ignore\}([\s\S]*?)\{\/ignore\}/,process:e=>({content:e[1]})},...[{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(\{[^}]*\}|\[[^}]*\])\}/,process:e=>({variable:e[1],value:e[2]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*([^}\s][^}]*)\}/,process:e=>({variable:e[1],value:e[2].trim()})},{type:"add",regex:/^\{add\s+\$(\w+)\s*\+\+\}/,process:e=>({variable:e[1]})},{type:"var",regex:/^\{var\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})}],...[{type:"unset",regex:/^\{unset\s+\$(\w+)\}/,process:e=>({variable:e[1]})},{type:"comment",regex:/^\{\*\s*([\s\S]*?)\s*\*\}/}],...[{type:"cycle",regex:/^\{cycle\s+(.+?)\}/,process:e=>({values:e[1]})}],...[{type:"filter",regex:/^\{filter\s+(.+?)\}/,process:e=>({filter:e[1].trim()})},{type:"endfilter",regex:/^\{\/filter\}/},{type:"raw",regex:/^\{raw\}/},{type:"endraw",regex:/^\{\/raw\}/},{type:"autoescape",regex:/^\{autoescape\}/},{type:"endautoescape",regex:/^\{\/autoescape\}/}],...[{type:"macro",regex:/^\{macro\s+(\w+)(?:\s*\((.*?)\))?\}/,process(e){const t=e[2]?e[2].split(",").map(e=>e.trim()):[];return{name:e[1],args:t}}},{type:"endmacro",regex:/^\{\/macro\}/},{type:"import",regex:/^\{import\s+(['"])(.*?)\1\s+as\s+(\w+)\}/,process:e=>({file:e[2],alias:e[3]})}],{type:"output",regex:/^\{output\s+name\s*=\s*(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+([^\s}]+)\s*\}/,process:e=>({name:e[1],filters:[]})},{type:"output",regex:/^\{output\s+(\$?[^}]+)\}/,process:e=>({name:e[1].trim(),filters:[]})},{type:"output",regex:/^\{\$(.+?)\}/,process:e=>{const t=e[1].trim().split("|").map(e=>e.trim());return{name:`$${t[0]}`,filters:t.slice(1)}}},{type:"output",regex:/^\{([^$].+?)\}/,process:e=>({name:e[1].trim(),filters:[]})}];function t(t){const r=[];let s=0;for(;s<t.length;){let n=!1;if(t.slice(s).startsWith("{ignore}")){let e=1,o=s+8;for(;o<t.length;)if(t.length-o>=8&&t.startsWith("{ignore}",o))e++,o+=8;else if(t.length-o>=9&&t.startsWith("{/ignore}",o)){if(e--,o+=9,0===e){const e=t.slice(s+8,o-9);r.push({type:"text",value:e}),s=o,n=!0;break}}else o++;n||(r.push({type:"text",value:"{ignore}"}),s+=8);continue}if("{"!==t[s]){const e=t.indexOf("{",s);if(-1===e){r.push({type:"text",value:t.slice(s)});break}e>s&&r.push({type:"text",value:t.slice(s,e)}),s=e}for(const o of e){const e=t.slice(s).match(o.regex);if(e){const t={type:o.type,value:e[0]};if("comment"===o.type){s+=e[0].length,n=!0;break}o.process&&Object.assign(t,o.process(e)),r.push(t),s+=e[0].length,n=!0;break}}if(!n){const e=t.slice(s,s+30).replace(/\n/g,"↵");console.warn(`Skip unknown tag at ${s}: "${e}"`),s++}}return r}function r(e,t){const r={type:"if",condition:e[t].condition,body:[],elseIfs:[],elseBody:[]};let s=t+1,n=0;const a=[],i=[],c=[];let l=null,u=!1;for(;s<e.length;){const t=e[s];if("if"===t.type&&n++,"endif"===t.type){if(0===n)break;n--}if(n>0)l||u?l?l.tokens.push(t):u&&c.push(t):a.push(t),s++;else if("elseif"!==t.type)if("else"!==t.type){if("endif"===t.type)break;l||u?l?l.tokens.push(t):u&&c.push(t):a.push(t),s++}else l=null,u=!0,s++;else l||u?l?l.tokens.push(t):u&&c.push(t):(l={condition:t.condition,tokens:[]},i.push(l)),s++}return r.body=o(a),r.elseIfs=i.map(e=>({condition:e.condition,body:o(e.tokens)})),r.elseBody=o(c),{node:r,nextIndex:s+1}}function s(e,t){const r=e[t];let s;if("for_range"===r.type)s={type:"for_range",start:r.start,end:r.end,item:r.item,reverse:Boolean(r.reverse),body:[],elseBody:[]};else{if("for"!==r.type&&"foreach"!==r.type)throw new Error(`Invalid for token at ${t}: ${r.type}`);s={type:"for",collection:r.collection,item:r.item,key:r.key||null,reverse:Boolean(r.reverse),body:[],elseBody:[]}}let n=t+1,a=0,i=!1;const c=[],l=[];for(;n<e.length;){const t=e[n];if("for"!==t.type&&"foreach"!==t.type&&"for_range"!==t.type||a++,"endfor"===t.type||"endforeach"===t.type){if(!(a>0))break;a--}"foreachelse"!==t.type||0!==a?(i?l.push(t):c.push(t),n++):(i=!0,n++)}if(n>=e.length)throw new Error("Unclosed for loop: expected {/for}");return s.body=o(c),l.length>0&&(s.elseBody=o(l)),{node:s,nextIndex:n+1}}function n(e,t){const r={type:"switch",value:e[t].value,cases:[],defaultBody:[]};let s=t+1,n=0,o=null,a=!1;for(;s<e.length;){const t=e[s];if("switch"===t.type&&n++,"endswitch"===t.type){if(n>0){n--,o&&o.body.push(t),s++;continue}return{node:r,nextIndex:s+1}}if(n>0)o&&o.body.push(t),s++;else if("case"!==t.type)if("default"!==t.type)o?o.body.push(t):a?r.defaultBody.push(t):r.cases.length>0&&r.cases[r.cases.length-1].body.push(t),s++;else{if(a)throw new Error("Duplicate {default} in switch");a=!0,o=null,s++}else o={value:t.value,body:[]},r.cases.push(o),s++}throw new Error("Unclosed switch: expected {/switch}")}function o(e){const t=[];let a=0;for(;a<e.length;){const i=e[a];if("block_open"===i.type){const r=i.name;a++;const s=[];let n=0;for(;a<e.length;){const t=e[a];if("block_open"===t.type&&n++,"block_close"===t.type){if(0===n)break;n--}s.push(t),a++}const c=o(s);t.push({type:"block",name:r,body:c}),a++;continue}if("extends"!==i.type)if("include"!==i.type)if(["set","var","add"].includes(i.type))t.push({...i}),a++;else{if("if"===i.type){const{node:s,nextIndex:n}=r(e,a);t.push(s),a=n;continue}if(["for","foreach","for_range"].includes(i.type)){const{node:r,nextIndex:n}=s(e,a);t.push(r),a=n;continue}if("switch"===i.type){const{node:r,nextIndex:s}=n(e,a);t.push(r),a=s;continue}if("output"===i.type){const e=i.value.match(/^\{\$(.+)\}$/);if(!e){t.push({type:"text",value:i.value}),a++;continue}const r=e[1].trim().split("|"),s=r[0],n=r.slice(1);t.push({type:"output",name:`$${s}`,filters:n}),a++;continue}["elseif","else","endif","endfor","endforeach","endswitch"].includes(i.type)||t.push({...i}),a++}else t.push({...i}),a++;else t.push({...i}),a++}return t}function a(e){const t=function(e){const t=[],r=/(\s+|[$a-zA-Z_]\w*(?:\.\w+)*|"(?:[^"\\]|\\.)*"|'(?:[^'\\]|\\.)*'|\d+(?:\.\d+)?|[-+*/%<>=!&|?:(){}[\]~]+|[\w-]+:)/g;let s;const n=e=>["+","-","*","/","%","==","!=","<","<=",">",">=","&&","||","!","(",")","?",":","~"].includes(e);for(;null!==(s=r.exec(e));){const e=s[0].trim();if(e)if(n(e))t.push({type:"op",value:e});else if("|"===e)t.push({type:"filter",value:e});else if(e.startsWith("$"))t.push({type:"var",value:e});else if(/^["']/.test(e)){const r=e.slice(1,-1).replace(/\\(.)/g,"$1");t.push({type:"str",value:r})}else isNaN(+e)?t.push({type:"str",value:e}):t.push({type:"num",value:e})}return t}(e);let r=0;function s(){const e=o(()=>o(()=>o(()=>o(()=>o(()=>n(),["*","/","%"]),["+","-","~"]),["<","<=",">",">="]),["==","!="]),["||","&&"]);if(r<t.length&&"?"===t[r].value){r++;const n=s();r<t.length&&":"===t[r].value&&r++;return{type:"conditional",test:e,consequent:n,alternate:s()}}return e}function n(){if(r<t.length&&["!","+","-"].includes(t[r].value)){const e=t[r].value;return r++,{type:"unary",operator:e,argument:n()}}return function(){const e=t[r];if(!e)throw new Error("Unexpected end of expression");if("num"===e.type)return r++,{type:"literal",value:+e.value};if("str"===e.type)return r++,{type:"literal",value:e.value};if("var"===e.type)return r++,{type:"variable",path:e.value.slice(1)};if("("===e.value){r++;const e=s();if(r>=t.length||")"!==t[r].value)throw new Error("Expected )");return r++,e}throw new Error(`Unexpected token: ${e.value}`)}()}function o(e,s){let n=e();for(;r<t.length&&s.includes(t[r].value);){const s=t[r].value;r++;n={type:"binary",operator:s,left:n,right:e()}}return n}return s()}function i(e){if("true"===(e=e.trim()))return!0;if("false"===e)return!1;if("null"===e)return null;if("undefined"!==e){if(!isNaN(+e)&&!e.includes(" "))return+e;if(/^["'](.*)["']$/.test(e))return e.slice(1,-1);if(e.startsWith("[")&&e.endsWith("]"))try{return e.slice(1,-1).split(",").map(e=>e.trim()).map(i)}catch{}if(e.startsWith("{")&&e.endsWith("}"))try{return JSON.parse(e.replace(/(\w+):/g,'"$1":').replace(/'/g,'"'))}catch{}return e}}function c(e,t,r){return(...s)=>{const n=s[0];let o=!1;switch(t){case"array":o=Array.isArray(n);break;case"string":o="string"==typeof n;break;case"object":o=n&&"object"==typeof n&&!Array.isArray(n)}return o||console.warn(`[Fenom] filter '${e}' should be used with ${t}, but got ${typeof n}`),r(...s)}}function l(e,t){if(!e||"string"!=typeof e)return;const r=(e.startsWith("$")?e.slice(1):e).split(".").map(e=>e.trim());let s=t;for(const n of r){if(null==s||"object"!=typeof s)return;s=s[n]}return s}function u(e,t,r,s){let n=e;for(const a of t){const[e,...t]=a.split(":").map(e=>e.trim()),i=s[e];if("function"==typeof i){const e=t.map(e=>/^["'].*["']$/.test(e)?e.slice(1,-1):isNaN(+e)?e.startsWith("$")?l(e.slice(1),r)??"":e:+e);try{n=i(n,...e)}catch(o){n=""}}}return n}function p(e,t,r){switch(e.type){case"literal":return e.value;case"variable":return l(e.path,t)??"";case"unary":const s=p(e.argument,t,r);switch(e.operator){case"!":return!s;case"+":return+s;case"-":return-s}break;case"binary":{const s=p(e.left,t,r),n=p(e.right,t,r);switch(e.operator){case"+":return s+n;case"-":return s-n;case"*":return s*n;case"/":return s/n;case"%":return s%n;case"==":return s==n;case"!=":return s!=n;case"<":return s<n;case"<=":return s<=n;case">":return s>n;case">=":return s>=n;case"&&":return s&&n;case"||":return s||n;case"~":return String(s)+String(n)}break}case"conditional":const n=p(e.test,t,r);return p(n?e.consequent:e.alternate,t,r);case"filter":{const s=p(e.expression,t,r),n=e.args.map(e=>p(e,t,r)),o=r[e.filter];return"function"==typeof o?o(s,...n):s}}return""}async function f(e,r,s={},n={}){var c,y;let g="";for(const b of e)switch(b.type){case"text":g+=b.value;break;case"ignore_block":g+=b.content||"";break;case"comment":case"extends":break;case"output":try{const e=b.name.trim();let t;if(/[+\-*/%<>!=&|?:~]/.test(e)){t=p(a(e),s,n)}else t=l(e,s)??"";const r=u(t,b.filters,s,n);g+=String(r)}catch(d){console.warn(`Eval error: ${b.name}`,d),g+=""}break;case"set":try{const e=b.value.trim();if(/[+\-*/%~]/.test(e)){const t=a(e);s[b.variable]=p(t,s,n)}else e.startsWith("$")?s[b.variable]=l(e,s)??"":s[b.variable]=i(e)}catch(d){s[b.variable]=""}break;case"var":void 0===s[b.variable]&&(s[b.variable]=i(b.value));break;case"add":s[b.variable]=(s[b.variable]||0)+1;break;case"if":{let e=!1;try{e=!!p(a(b.condition),s,n)}catch(d){console.warn(`Condition error: ${b.condition}`,d)}const t=e?b.body:(null==(y=null==(c=b.elseIfs)?void 0:c.find(e=>{try{return!!p(a(e.condition),s,n)}catch{return!1}}))?void 0:y.body)||b.elseBody||[];g+=await f(t,r,s,n);break}case"for_range":{const{start:e,end:t,item:o,reverse:a,body:i,elseBody:c}=b,l=[];for(let r=e;r<=t;r++)l.push(r);a&&l.reverse();let u="";if(0===l.length&&c)u+=await f(c,r,s,n);else for(const p of l){const c={...s};c[o]=p,c.loop={index:p-e+1,first:p===(a?t:e),last:p===(a?e:t),key:p-e},u+=await f(i,r,c,n)}g+=u;break}case"for":{const e=l(b.collection.startsWith("$")?b.collection.slice(1):b.collection,s);let t=[];if(Array.isArray(e)?t=Array.from(e.entries()):e&&"object"==typeof e&&(t=Object.entries(e)),b.reverse&&(t=t.reverse()),0===t.length&&b.elseBody)g+=await f(b.elseBody,r,s,n);else for(const[o,a]of t){const e={...s};e[b.item]=a,b.key&&(e[b.key]=o),e.loop={index:o+1,first:0===o,last:o===t.length-1,key:o},g+=await f(b.body,r,e,n)}break}case"block":"function"==typeof s.block&&(g+=await s.block(b.name));break;case"include":if(!r){console.warn(`{include '${b.file}'} ignored: no loader`);break}try{const e=await r(b.file),a=o(t(e));g+=await f(a,r,{...s,...b.params},n)}catch(h){g+=`<span style="color:red">[Include error: ${h.message}]</span>`}break;default:console.warn(`Unknown node type: ${b.type}`)}return g}function y(e,r){const s={};let n=null;for(const t of e)"extends"===t.type?n=t.file:"block"===t.type&&(s[t.name]=t.body);return n?async function(e,a){if(!r)throw new Error(`Template uses {extends '${n}'}, but no loader provided`);try{const i=await r(n),c=o(t(i)),l={};for(const e of c)"block"===e.type&&(l[e.name]=e.body);const u={...l,...s},p={};return e.block=async t=>{if(void 0!==p[t])return p[t];const s=u[t];return s?(p[t]=await f(s,r,e,a),p[t]):(p[t]="","")},await f(c,r,e,a)}catch(i){return`[Render error: ${i.message}]`}}:async function(t,s){return await f(e,r,t,s)}}const g={upper:e=>String(e).toUpperCase(),lower:e=>String(e).toLowerCase(),capitalize:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},ucfirst:e=>g.capitalize(e),ucwords:e=>String(e).trim().replace(/\b\w/g,e=>e.toUpperCase()),lcfirst:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toLowerCase()+t.slice(1)},trim:e=>String(e).trim(),ltrim:e=>String(e).replace(/^\s+/,""),rtrim:e=>String(e).replace(/\s+$/,""),nl2br:e=>String(e).replace(/\n/g,"<br>"),replace:(e,t,r)=>String(e).split(String(t)).join(String(r)),substr:c("substr","string",(e,t,r)=>{const s=String(e);return void 0===r?s.slice(t):s.slice(t,t+r)}),urlencode:e=>encodeURIComponent(String(e)),urldecode:e=>decodeURIComponent(String(e)),escape:c("escape","string",e=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),e:e=>g.escape(e),first:c("first","array",e=>Array.isArray(e)?e[0]:e&&"object"==typeof e?Object.values(e)[0]:""),last:c("last","array",e=>{if(Array.isArray(e))return e[e.length-1];if(e&&"object"==typeof e){const t=Object.values(e);return t[t.length-1]}return""}),join:c("join","array",(e,t=",")=>Array.isArray(e)?e.join(t):e&&"object"==typeof e?Object.values(e).join(t):String(e)),reverse:c("reverse","array",e=>Array.isArray(e)?[...e].reverse():e),sort:c("sort","array",e=>Array.isArray(e)?[...e].sort():e),ksort:c("ksort","object",e=>{if(e&&"object"==typeof e){const t={};return Object.keys(e).sort().forEach(r=>{t[r]=e[r]}),t}return e}),unique:c("unique","array",e=>Array.isArray(e)?[...new Set(e)]:e),shuffle:c("shuffle","array",e=>{if(!Array.isArray(e))return e;const t=[...e];for(let r=t.length-1;r>0;r--){const e=Math.floor(Math.random()*(r+1));[t[r],t[e]]=[t[e],t[r]]}return t}),slice:(e,t,r)=>Array.isArray(e)||"string"==typeof e?void 0===r?e.slice(t):e.slice(t,t+r):e,merge:(e,t)=>Array.isArray(e)&&Array.isArray(t)?[...e,...t]:e,batch:(e,t)=>{if(!Array.isArray(e))return e;const r=[];for(let s=0;s<e.length;s+=t)r.push(e.slice(s,s+t));return r},keys:e=>e&&"object"==typeof e?Object.keys(e):[],values:e=>e&&"object"==typeof e?Object.values(e):[],length:e=>Array.isArray(e)?e.length:e&&"object"==typeof e?Object.keys(e).length:String(e).length,number_format:(e,t=0,r=".",s=",")=>{const n=Number(e);return isNaN(n)?"":n.toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:!0}).replace(/,/g,s).replace(/\./g,r)},abs:e=>Math.abs(Number(e)||0),round:(e,t=0)=>{const r=10**t;return Math.round((Number(e)||0)*r)/r},json_encode:e=>JSON.stringify(e),json_decode:e=>{try{return JSON.parse(String(e))}catch{return null}},date:(e,t="d.m.Y")=>{const r=Number(e),s=new Date(isNaN(r)?e:1e3*r);if(isNaN(s.getTime()))return console.warn(`[Fenom] filter 'date' received invalid timestamp: ${e}`),"";const n=e=>e.toString().padStart(2,"0");return t.replace(/d/g,n(s.getDate())).replace(/m/g,n(s.getMonth()+1)).replace(/Y/g,s.getFullYear().toString()).replace(/H/g,n(s.getHours())).replace(/i/g,n(s.getMinutes())).replace(/s/g,n(s.getSeconds()))},default:(e,t)=>null==e||""===e||"object"==typeof e&&0===Object.keys(e).length?t:e,raw:e=>e,var_dump:e=>`<pre>${JSON.stringify(e,null,2)}</pre>`,print_r:e=>`<pre>${e instanceof Object?JSON.stringify(e,null,2):String(e)}</pre>`};async function d(e,r){const{context:s={},loader:n,minify:a=!1}=r||{};try{const r=t(e),i=y(o(r),n),c=await i(s,g);return a?function(e){return e.replace(/>\s+</g,"><").replace(/\s{2,}/g," ").replace(/(<!--.*?-->)\s+/g,"$1").trim()}(c):c}catch(i){return console.error("Template error:",i),`<span style="color:red">[Ошибка шаблона: ${i.message}]</span>`}}export{d as FenomJs,y as compile,o as parse,t as tokenize};
