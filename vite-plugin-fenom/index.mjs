import e from"node:fs";import{join as t,relative as s,basename as r,dirname as n,resolve as o}from"path";import i from"node:path";import{readFileSync as c}from"fs";function a(t){const s={};if(!e.existsSync(t))return console.warn(`[collectJsonDataMerged] –ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${t}`),s;return function t(r){const n=e.readdirSync(r,{withFileTypes:!0});for(const c of n){const n=i.join(r,c.name);if(c.isDirectory())t(n);else if(c.isFile()&&/\.json$/i.test(c.name))try{const t=JSON.parse(e.readFileSync(n,"utf-8"));Object.assign(s,t)}catch(o){console.error(`[collectJsonDataMerged] –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: ${n}`,o)}}}(t),s}function l(e){return function(s){const r=t(e,s);if(!r.endsWith(".tpl"))throw new Error(`Template path must end with .tpl: ${s}`);if(!c(r,"utf-8"))throw new Error(`Template not found: ${r}`);return c(r,"utf-8")}}function p(e,t){const s={type:"if",condition:e[t].condition,body:[],elseIfs:[],elseBody:[]};let r=t+1,n=0;const o=[],i=[],c=[];let a=null,l=!1;for(;r<e.length;){const t=e[r];if("if"===t.type&&n++,"endif"===t.type){if(0===n)break;n--}if(n>0)a||l?a?a.tokens.push(t):l&&c.push(t):o.push(t),r++;else if("elseif"!==t.type)if("else"!==t.type){if("endif"===t.type)break;a||l?a?a.tokens.push(t):l&&c.push(t):o.push(t),r++}else l=!0,r++;else a||l?a?a.tokens.push(t):l&&c.push(t):(a={condition:t.condition,tokens:[]},i.push(a)),r++}return s.body=y(o),s.elseIfs=i.map(e=>({condition:e.condition,body:y(e.tokens)})),s.elseBody=y(c),{node:s,nextIndex:r+1}}function u(e,t){const s=e[t],r={type:"for",key:s.key||null,item:s.item,collection:s.collection,reverse:Boolean(s.reverse),body:[],elseBody:[]};let n=t+1,o=0,i=!1;for(;n<e.length;){const t=e[n];if("for"===t.type&&o++,"endfor"===t.type){if(o>0){o--,i?r.elseBody.push(t):r.body.push(t),n++;continue}return{node:r,nextIndex:n+1}}if(o>0)i?r.elseBody.push(t):r.body.push(t),n++;else if("foreachelse"!==t.type)["break","continue"].includes(t.type),i?r.elseBody.push(t):r.body.push(t),n++;else{if(0===o){i=!0,n++;continue}r.body.push(t),n++}}throw new Error("Unclosed for loop: expected {/for}")}function f(e,t){const s={type:"switch",value:e[t].value,cases:[],defaultBody:[]};let r=t+1,n=0,o=null,i=!1;for(;r<e.length;){const t=e[r];if("switch"===t.type&&n++,"endswitch"===t.type){if(n>0){n--,o&&o.body.push(t),r++;continue}return{node:s,nextIndex:r+1}}if(n>0)o&&o.body.push(t),r++;else if("case"!==t.type)if("default"!==t.type)o?o.body.push(t):i?s.defaultBody.push(t):s.cases.length>0&&s.cases[s.cases.length-1].body.push(t),r++;else{if(i)throw new Error("Duplicate {default} in switch");i=!0,o=null,r++}else o={value:t.value,body:[]},s.cases.push(o),r++}throw new Error("Unclosed switch: expected {/switch}")}function y(e){const t=[];let s=0;for(;s<e.length;){const r=e[s];if("block_open"===r.type){const n=r.name;s++;const o=[];let i=0;for(;s<e.length;){const t=e[s];if("block_open"===t.type&&i++,"block_close"===t.type){if(0===i)break;i--}o.push(t),s++}const c=y(o);t.push({type:"block",name:n,body:c}),s++;continue}if("extends"!==r.type)if("include"!==r.type)if(["set","var","add"].includes(r.type))t.push({...r}),s++;else{if("if"===r.type){const{node:r,nextIndex:n}=p(e,s);t.push(r),s=n;continue}if("for"===r.type||"foreach"===r.type){const{node:r,nextIndex:n}=u(e,s);t.push(r),s=n;continue}if("switch"===r.type){const{node:r,nextIndex:n}=f(e,s);t.push(r),s=n;continue}if("output"===r.type){const e=r.value.match(/^\{\$(.+)\}$/);if(!e){t.push({type:"text",value:r.value}),s++;continue}const n=e[1].trim().split("|"),o=n[0],i=n.slice(1);t.push({type:"output",name:`$${o}`,filters:i}),s++;continue}t.push({...r}),s++}else t.push({...r}),s++;else t.push({...r}),s++}return t}const h=e=>"true"===(e=e.trim())?"true":"false"===e?"false":"null"===e?"null":"undefined"===e?"undefined":isNaN(Number(e))||e.includes(" ")?e.startsWith("[")&&e.endsWith("]")||e.startsWith("{")&&e.endsWith("}")||e.includes("$")?e.replace(/\$(\w+)/g,"context.$1"):JSON.stringify(e):e;function d(e){const t=e.trim();if(t.includes("~"))return function(e){const t=[];let s="",r=!1,n=0;for(let o of e)'"'!==o&&"'"!==o||0!==n||(r=!r),"("!==o||r||n++,")"!==o||r||n--,"~"!==o||r||0!==n?s+=o:s.trim()&&(t.push(s.trim()),s="");return s.trim()&&t.push(s.trim()),0===t.length?'""':1===t.length?d(t[0]):t.map(e=>d(e)).join(" + ")}(t);if(/^['"].*['"]$/.test(t))return t;if(/^\d+$/.test(t))return t;if("true"===t||"false"===t||"null"===t)return t;if(t.startsWith("$")){const e=t.slice(1).split(".");return e.length>1?`(${e.map((t,s)=>"context."+e.slice(0,s+1).join(".")).join(" != null ? ")+" != null ? context."+e.join(".")+":null".repeat(e.length)})`:`context.${e[0]}`}return`(${t})`}function g(e,t,s){return(r,...n)=>{const o=typeof r,i=Array.isArray(r),c="string"===o,a=r&&"object"==typeof r&&!i;let l=!1;if("array"===t&&(l=i),"string"===t&&(l=c),"object"===t&&(l=a),"number"===t&&(l=!isNaN(Number(r))),!l&&null!=r){const s=i?"array":c?"string":a?"object":o;console.warn(`[Fenom] filter '${e}' expects ${t}, got ${s}`)}return s(r,...n)}}function $(e){return e.replace(/\$(\w+(?:\.\w+)*)(?:\|(\w+)(?::([^:\s}]+))?(?::([^:\s}]+))?)*/g,(e,t,s,r,n)=>{t.replace(/\./g,"][");const o=d(`$${t}`);if(!s)return o;const i=[];r&&i.push(/^['"]/.test(r)?r:d("$"+r)),n&&i.push(/^['"]/.test(n)?n:d("$"+n));const c=i.join(", ");return`filters["${s}"](${o}${c?", "+c:""})`})}const m=[{type:"extends",regex:/^\{extends\s+['"]file:([^'"]+)['"]\s*\}/,process:e=>({file:e[1]})},{type:"block_open",regex:/^\{block\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2]})},{type:"block_close",regex:/^\{\/block\}/},{type:"parent",regex:/^\{parent\}/},{type:"paste",regex:/^\{paste\s+(['"])(.*?)\1\}/,process:e=>({name:e[2]})},{type:"use",regex:/^\{use\s+(['"])(.*?)\1\}/,process:e=>({file:e[2]})},{type:"include",regex:/^\{include\s+['"]file:([^'"]+)['"](?:\s+((?:\s*\w+\s*=\s*(?:"[^"]*"|'[^']*'|[^\s}]+))+))?\s*\}/,process:e=>{const t=e[1],s=e[2],r={};if(s){const e=/(\w+)\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s}]+))/g;let t;for(;null!==(t=e.exec(s));){const e=t[1],s=t[2]||t[3]||t[4]||"";r[e]=s}}return{file:t,params:r}}},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,item:e[3],key:null,reverse:e[0].includes("| reverse")})},{type:"for",regex:/^\{(for|foreach)\s*\$(\w+(?:\.\w+)?)\s+as\s*\$(\w+)\s*=>\s*\$(\w+)(?:\s*\|\s*reverse)?\s*\}/,process:e=>({collection:`$${e[2]}`,key:e[3],item:e[4],reverse:e[0].includes("| reverse")})},{type:"endfor",regex:/^\{\/(?:for|foreach)\}/},{type:"break",regex:/^\{break\}/i},{type:"continue",regex:/^\{continue\}/i},{type:"switch",regex:/^\{switch\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"case",regex:/^\{case\s+(.+?)\}/,process:e=>({value:e[1].trim()})},{type:"default",regex:/^\{default\}/},{type:"endswitch",regex:/^\{\/switch\}/},{type:"operator",regex:/^\{\$(\w+)\s*(\+\+|--|\+=|-=|\*=|\/=|\%=)\s*([^}]+)?\}/,process:e=>({variable:e[1],operator:e[2],value:e[3]?.trim()||"1"})},{type:"if",regex:/^\{if\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"elseif",regex:/^\{elseif\s+(.+?)\}/,process:e=>({condition:e[1].trim()})},{type:"else",regex:/^\{else\}/},{type:"endif",regex:/^\{\/if\}/},{type:"ignore_block",regex:/^\{ignore\}([\s\S]*?)\{\/ignore\}/,process:e=>({content:e[1]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(\{[^}]*\}|\[[^}]*\])\}/,process:e=>({variable:e[1],value:e[2]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})},{type:"set",regex:/^\{set\s+\$(\w+)\s*=\s*([^}\s][^}]*)\}/,process:e=>({variable:e[1],value:e[2].trim()})},{type:"add",regex:/^\{add\s+\$(\w+)\s*\+\+\}/,process:e=>({variable:e[1]})},{type:"var",regex:/^\{var\s+\$(\w+)\s*=\s*(['"])(.*?)\2\}/,process:e=>({variable:e[1],value:e[3]})},{type:"unset",regex:/^\{unset\s+\$(\w+)\}/,process:e=>({variable:e[1]})},{type:"comment",regex:/^\{\*\s*([\s\S]*?)\s*\*\}/},{type:"output",regex:/^\{output\s+name\s*=\s*(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+(['"])(.*?)\1\s*\}/,process:e=>({name:e[2],filters:[]})},{type:"output",regex:/^\{output\s+([^\s}]+)\s*\}/,process:e=>({name:e[1],filters:[]})},{type:"output",regex:/^\{output\s+(\$?[^}]+)\}/,process:e=>({name:e[1].trim(),filters:[]})},{type:"output",regex:/^\{\$(.+?)\}/,process:e=>{const t=e[1].trim().split("|").map(e=>e.trim());return{name:`$${t[0]}`,filters:t.slice(1)}}},{type:"output",regex:/^\{([^$].+?)\}/,process:e=>({name:e[1].trim(),filters:[]})},{type:"cycle",regex:/^\{cycle\s+(.+?)\}/,process:e=>({values:e[1]})},{type:"filter",regex:/^\{filter\s+(.+?)\}/,process:e=>({filter:e[1].trim()})},{type:"endfilter",regex:/^\{\/filter\}/},{type:"raw",regex:/^\{raw\}/},{type:"endraw",regex:/^\{\/raw\}/},{type:"autoescape",regex:/^\{autoescape\}/},{type:"endautoescape",regex:/^\{\/autoescape\}/},{type:"macro",regex:/^\{macro\s+(\w+)(?:\s*\((.*?)\))?\}/,process(e){const t=e[2]?e[2].split(",").map(e=>e.trim()):[];return{name:e[1],args:t}}},{type:"endmacro",regex:/^\{\/macro\}/},{type:"import",regex:/^\{import\s+(['"])(.*?)\1\s+as\s+(\w+)\}/,process:e=>({file:e[2],alias:e[3]})}];function x(e){const t=[];let s=0;for(;s<e.length;){let r=!1;if(e.slice(s).startsWith("{ignore}")){let n=1,o=s+8;for(;o<e.length;)if(e.slice(o).startsWith("{ignore}"))n++,o+=8;else if(e.slice(o).startsWith("{/ignore}")){if(n--,o+=9,0===n){const n=e.slice(s+8,o-9);t.push({type:"text",value:n}),s=o,r=!0;break}}else o++;r||(t.push({type:"text",value:"{ignore}"}),s+=8);continue}if("{"!==e[s]){const r=e.indexOf("{",s);if(-1===r){t.push({type:"text",value:e.slice(s)});break}r>s&&t.push({type:"text",value:e.slice(s,r)}),s=r}for(const n of m){const o=e.slice(s).match(n.regex);if(o){const e={type:n.type,value:o[0]};if("comment"===n.type){s+=o[0].length,r=!0;break}n.process&&Object.assign(e,n.process(o)),t.push(e),s+=o[0].length,r=!0;break}}if(!r){const t=e.slice(s,s+30).replace(/\n/g,"‚Üµ");console.warn(`Skip unknown tag at ${s}: "${t}"`),s++}}return t}const b={upper:e=>String(e).toUpperCase(),lower:e=>String(e).toLowerCase(),capitalize:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toUpperCase()+t.slice(1).toLowerCase()},ucfirst:e=>b.capitalize(e),ucwords:e=>String(e).trim().replace(/\b\w/g,e=>e.toUpperCase()),lcfirst:e=>{const t=String(e).trim();return 0===t.length?"":t.charAt(0).toLowerCase()+t.slice(1)},trim:e=>String(e).trim(),ltrim:e=>String(e).replace(/^\s+/,""),rtrim:e=>String(e).replace(/\s+$/,""),nl2br:e=>String(e).replace(/\n/g,"<br>"),replace:(e,t,s)=>String(e).split(String(t)).join(String(s)),substr:g("substr","string",(e,t,s)=>{const r=String(e);return void 0===s?r.slice(t):r.slice(t,t+s)}),urlencode:e=>encodeURIComponent(String(e)),urldecode:e=>decodeURIComponent(String(e)),escape:g("escape","string",e=>String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")),e:e=>b.escape(e),first:g("first","array",e=>Array.isArray(e)?e[0]:e&&"object"==typeof e?Object.values(e)[0]:""),last:g("last","array",e=>{if(Array.isArray(e))return e[e.length-1];if(e&&"object"==typeof e){const t=Object.values(e);return t[t.length-1]}return""}),join:g("join","array",(e,t=",")=>Array.isArray(e)?e.join(t):e&&"object"==typeof e?Object.values(e).join(t):String(e)),reverse:g("reverse","array",e=>Array.isArray(e)?[...e].reverse():"string"==typeof e?e.split("").reverse().join(""):e),sort:g("sort","array",e=>Array.isArray(e)?[...e].sort():e),ksort:g("ksort","object",e=>{if(e&&"object"==typeof e){const t={};return Object.keys(e).sort().forEach(s=>{t[s]=e[s]}),t}return e}),unique:g("unique","array",e=>Array.isArray(e)?[...new Set(e)]:e),shuffle:g("shuffle","array",e=>{if(!Array.isArray(e))return e;const t=[...e];for(let s=t.length-1;s>0;s--){const e=Math.floor(Math.random()*(s+1));[t[s],t[e]]=[t[e],t[s]]}return t}),slice:(e,t,s)=>Array.isArray(e)||"string"==typeof e?void 0===s?e.slice(t):e.slice(t,t+s):e,merge:(e,t)=>Array.isArray(e)&&Array.isArray(t)?[...e,...t]:e,batch:(e,t)=>{if(!Array.isArray(e))return e;const s=[];for(let r=0;r<e.length;r+=t)s.push(e.slice(r,r+t));return s},keys:e=>e&&"object"==typeof e?Object.keys(e):[],values:e=>e&&"object"==typeof e?Object.values(e):[],length:e=>Array.isArray(e)?e.length:e&&"object"==typeof e?Object.keys(e).length:String(e).length,number_format:(e,t=0,s=".",r=",")=>{const n=Number(e);return isNaN(n)?"":n.toLocaleString("en-US",{minimumFractionDigits:t,maximumFractionDigits:t,useGrouping:!0}).replace(/,/g,r).replace(/\./g,s)},abs:e=>Math.abs(Number(e)||0),round:(e,t=0)=>{const s=10**t;return Math.round((Number(e)||0)*s)/s},json_encode:e=>JSON.stringify(e),json_decode:e=>{try{return JSON.parse(String(e))}catch{return null}},date:(e,t="d.m.Y")=>{const s=Number(e),r=new Date(isNaN(s)?e:1e3*s);if(isNaN(r.getTime()))return console.warn(`[Fenom] filter 'date' received invalid timestamp: ${e}`),"";const n=e=>e.toString().padStart(2,"0");return t.replace(/d/g,n(r.getDate())).replace(/m/g,n(r.getMonth()+1)).replace(/Y/g,r.getFullYear().toString()).replace(/H/g,n(r.getHours())).replace(/i/g,n(r.getMinutes())).replace(/s/g,n(r.getSeconds()))},default:(e,t)=>null==e||""===e||"object"==typeof e&&0===Object.keys(e).length?t:e,raw:e=>e,var_dump:e=>`<pre>${JSON.stringify(e,null,2)}</pre>`,print_r:e=>`<pre>${e instanceof Object?JSON.stringify(e,null,2):String(e)}</pre>`};function w(e,t,s){const{root:r,loader:n,minify:o}=s||{root:"./src/"},i=n||(()=>"");try{const s=function(e,t){const s={};let r=null;const n=[];for(const a of e)"extends"!==a.type?"block"===a.type&&(s[a.name]=a.body):r=a.file;const o=e.filter(e=>"extends"!==e.type&&"block_open"!==e.type&&"block_close"!==e.type);function i(e){var r;if(!["extends","block_open","block_close"].includes(e.type)&&!["endfor"].includes(e.type))switch(e.type){case"operator":{const{variable:t,operator:s,value:r}=e,o=e=>e.startsWith("$")?`context.${e.slice(1)}`:isNaN(+e)?`'${e}'`:+e;switch(s){case"++":n.push(`context.${t} = (context.${t} || 0) + 1;`),n.push(`out += context.${t} - 1;`);break;case"--":n.push(`context.${t} = (context.${t} || 0) - 1;`),n.push(`out += context.${t} + 1;`);break;case"+=":n.push(`context.${t} = (context.${t} || 0) + ${o(r)};`),n.push(`out += context.${t};`);break;case"-=":n.push(`context.${t} = (context.${t} || 0) - ${o(r)};`),n.push(`out += context.${t};`);break;case"*=":n.push(`context.${t} = (context.${t} || 0) * ${o(r)};`),n.push(`out += context.${t};`);break;case"/=":n.push(`context.${t} = (context.${t} || 0) / ${o(r)};`),n.push(`out += context.${t};`);break;case"%=":n.push(`context.${t} = (context.${t} || 0) % ${o(r)};`),n.push(`out += context.${t};`)}break}case"ignore_block":n.push(`out += ${JSON.stringify(e.content)};`);break;case"include":try{const s=y(x(t(e.file)));if(e.params)for(const[t,r]of Object.entries(e.params))if("string"==typeof r)if(r.startsWith("$")){const e=r.slice(1);n.push(`context.${t} = context.${e};`)}else n.push(`context.${t} = ${JSON.stringify(r)};`);else n.push(`context.${t} = ${JSON.stringify(r)};`);s.forEach(i)}catch(o){n.push(`out += '[Include error: ${e.file}]';`)}break;case"text":n.push(`out += ${JSON.stringify(e.value)};`);break;case"output":{const t=d(e.name);let s=t;for(const r of e.filters){const e=r.split(":").map(e=>e.trim()),t=e[0],n=e.slice(1).map(e=>/^['"].*['"]$/.test(e)?e:d(e.startsWith("$")?e:"$"+e));s=`filters["${t}"](${s}${n.length>0?", "+n.join(", "):""})`}if(0===e.filters.length){const e=`(typeof ${t} === 'object' || ${t} === null ? '' : ${t})`;n.push(`out += ${e};`)}else n.push(`out += ${s};`);break}case"set":n.push(`context.${e.variable} = ${h(e.value)};`);break;case"var":n.push(`if (context.${e.variable} === undefined) context.${e.variable} = ${h(e.value)};`);break;case"add":n.push(`context.${e.variable} = (context.${e.variable} || 0) + 1;`);break;case"if":{const t=$(e.condition);n.push(`if (${t}) {`),e.body.forEach(i),n.push("}"),e.elseIfs.forEach(e=>{const t=$(e.condition);n.push(`else if (${t}) {`),e.body.forEach(i),n.push("}")}),e.elseBody.length>0&&(n.push("else {"),e.elseBody.forEach(i),n.push("}"));break}case"for":{const t=d(e.collection),s=`context.${e.item}`,r=e.key?`context.${e.key}`:null,o=`i_${e.item}`;n.push(`if (${t} && Array.isArray(${t}) && ${t}.length > 0) {`),e.reverse?n.push(`for (let ${o} = ${t}.length - 1; ${o} >= 0; ${o}--) {`):n.push(`for (let ${o} = 0; ${o} < ${t}.length; ${o}++) {`),r&&n.push(`${r} = ${o};`),n.push(`${s} = ${t}[${o}];`),e.body.forEach(i),n.push("}"),n.push("}"),e.elseBody&&e.elseBody.length>0&&(n.push("else {"),e.elseBody.forEach(i),n.push("}"));break}case"switch":n.push(`switch (${r=e.value,(r=r.replace(/(\$[a-zA-Z_]\w*(?:\.\w+)*)\s*[\?:!]\s*:/g,"$1 ? $1 : ")).replace(/\$([a-zA-Z_]\w*(?:\.\w+)*)/g,"context.$1")}) {`),e.cases.forEach(e=>{n.push(`case ${e.value}: {`),e.body.forEach(i),n.push("break; }")}),e.defaultBody&&e.defaultBody.length>0&&(n.push("default: {"),e.defaultBody.forEach(i),n.push("break; }")),n.push("}");break;case"block":{const t=s[e.name]||e.body;Array.isArray(t)?t.forEach(i):console.warn(`Block "${e.name}" has no body and no override`);break}default:console.warn(`Unknown node type: ${e.type}`)}}r&&e.some((e,t)=>"extends"===e.type&&0!==t)&&console.warn("{extends} –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–≤—ã–º —Ç–µ–≥–æ–º –≤ —à–∞–±–ª–æ–Ω–µ"),r?y(x(t(r))).forEach(i):o.forEach(i);const c=`\n        let out = '';\n        ${n.join("\n")}\n        return out;\n    `;return new Function("context","filters",c)}(y(x(e)),i),r=s(t,b);return o?r.replace(/>\s+</g,"><").replace(/\s{2,}/g," ").replace(/(<!--.*?-->)\s+/g,"$1").trim():r}catch(c){return console.error("Template error:",c),`<span style='color:red'>[–û—à–∏–±–∫–∞ —à–∞–±–ª–æ–Ω–∞: ${c.message}]</span>`}}function v(i={}){const c="./src",p="./src/data",u="pages",f=!1,y=!1,h={root:i.root??c,dataDir:i.dataDir??p,pagesDir:i.pagesDir??u,scanAll:i.scanAll??f,minify:i.minify??y};let d,g,$,m,x;return{name:"vite-plugin-fenom",configResolved(e){d=e,g=o(process.cwd(),h.root),$=o(process.cwd(),h.dataDir),x=h.pagesDir,m=h.minify},configureServer(s){const n=g,o=$,i=x;s.middlewares.use(async(s,r,c)=>{const p=s.url;if("/"===p||p?.endsWith(".html")){const s="/"===p?"index":p.replace(/^\/|\.html$/g,""),c=t(n,i),u=t(c,`${s}.tpl`),f=t(c,s,"index.tpl");let y="";if(e.existsSync(u)?y=u:e.existsSync(f)&&(y=f),y){const t=(e=>e.includes("</head>")?e.replace(/<\/head>/i,'<script type="module" src="/@vite/client"><\/script></head>'):e.includes("<head")?e.replace(/<head[\s\S]*?>/i,'$&<script type="module" src="/@vite/client"><\/script>'):e.includes("<body>")?e.replace(/<body>/i,'<body><script type="module" src="/@vite/client"><\/script>'):`<script type="module" src="/@vite/client"><\/script>${e}`)(w(e.readFileSync(y,"utf-8"),a(o),{root:n,loader:l(n),minify:m}));return r.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),void r.end(t)}}c()}),s.watcher.on("change",e=>{e.endsWith(".tpl")&&(console.log("üîÅ –®–∞–±–ª–æ–Ω –∏–∑–º–µ–Ω—ë–Ω ‚Äî –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞:",r(e)),s.ws?s.ws.send({type:"full-reload",path:"/"}):console.warn("[Fenom] WebSocket –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è HMR"))})},async generateBundle(){if("build"!==d.command)return;const o=t(g,x);if(!e.existsSync(o))return void this.warn(`[Fenom] –ü–∞–ø–∫–∞ "${x}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: ${o}`);const i=[];if(function s(r){if(e.existsSync(r))for(const n of e.readdirSync(r)){const o=t(r,n);e.statSync(o).isDirectory()?s(o):n.endsWith(".tpl")&&i.push(o)}}(o),h.scanAll){let s=function(r){if(e.existsSync(r))for(const n of e.readdirSync(r)){const c=t(r,n);e.statSync(c).isDirectory()?s(c):n.endsWith(".tpl")&&!c.startsWith(o)&&i.push(c)}};s(g)}this.info(`[Fenom] –ù–∞–π–¥–µ–Ω–æ —à–∞–±–ª–æ–Ω–æ–≤: ${i.length}`);for(const p of i)try{const i=e.readFileSync(p,"utf-8"),c=w(i,a($),{root:g,loader:l(g),minify:m}),u=p.startsWith(o)?o:g,f=s(u,p),y=r(f,".tpl"),h=n(f),d=t("."===h?"":h,`${y}.html`).replace(/\\/g,"/");if(d.startsWith("..")||d.startsWith("/")){this.warn(`[Fenom] –ü—Ä–æ–ø—É—â–µ–Ω –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º—ã–π –ø—É—Ç—å: ${d}`);continue}this.emitFile({type:"asset",fileName:d,source:c}),this.info(`‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞: ${d}`)}catch(c){this.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ ${p}: ${c}`)}}}}export{v as default};
